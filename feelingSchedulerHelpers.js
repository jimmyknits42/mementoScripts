function passesOR(e){var l=!1;if(e.length>0)for(var n=0;n<e.length;n++)if(1==e[n]){l=!0;break}return l}function passesAND(e){var l=!0;if(e.length>0){for(var n=0;n<e.length;n++)if(0==e[n]){l=!1;break}}else l=!1;return l}function passesBoolCondition(e,l){if(0==e.length)return!1;if(1==e.length)return e[0];if(e.length>1){if(null==l)return passesAND(e);switch(l){case"And":return passesAND(e);case"Or":return passesOR(e);default:return message("somehow have "+e.length+" booleans, but the operator is "+l),!1}}}function passesNumCondition(e,l,n){switch(l){case"Equals":return e==n;case"Less Than":return e<n;case"Less Than or Equal To":return e<=n;case"Greater Than":return e>n;case"Greater Than or Equal To":return e>=n;default:return message("somehow have operator = "+l+". num1 = "+e+". num2 = "+n),!1}}function ruleUsesOldCriteria(e){return e.field("Operator (Reference)").length>0}function feelPassesOldRuleCriteria(e,l){var n=e.field("Intensity"),i=l.field("Operator (Reference)");return i.length>0&&(i=i[0].field("displayID")),passesNumCondition(n,i,l.field("Compare Value"))}function clauseUsesValueComparison(e){return e.field("Value Comparison Operator (Reference)").length>0}function feelPassesValueComparisonClause(e,l){var n=e.field("Intensity"),i=l.field("Value Comparison Operator (Reference)");return i.length>0&&passesNumCondition(n,i=i[0].field("displayID"),l.field("Compare Value"))}function feelPassesDataExistenceClause(e,l){var n=l.field("Data Existence Operator (Reference)");if(null!=(n=n.length>0?n[0].field("displayID"):null)||l.field("Comment")||l.field("Locale Override")||l.field("Positive / Negative Override")||l.field("Body Parts")||l.field("Person Relationship")||l.field("Questionable Feeling")||l.field("Questionable Details"))return!1;var i=[];return l.field("Comment")&&i.push(feelHasComment(e)),l.field("Locale Override")&&i.push(feelHasLocaleOverride(e)),l.field("Positive / Negative Override")&&i.push(feelHasPosNegOverride(e)),l.field("Body Parts")&&i.push(feelHasBodyParts(e)),l.field("Person Relationship")&&i.push(feelHasPersonRelationship(e)),l.field("Questionable Feeling")&&i.push(feelHasFeelingQuestionable(e)),l.field("Questionable Details")&&i.push(feelHasDetailsQuestionable(e)),passesBoolCondition(i,n)}function feelPassesClause(e,l){return clauseUsesValueComparison(l)?feelPassesValueComparisonClause(e,l):feelPassesDataExistenceClause(e,l)}function feelPassesNewRuleCriteria(e,l){var n=l.field("Selection Criteria Operator (Reference)");n=n.length>0?n[0].field("displayID"):null;var i=l.field("Selection Clause (Reference)");if(i.length>0){for(var r=[],t=0;t<i.length;t++)r.push(feelPassesClause(e,i[t]));return passesBoolCondition(r,n)}return!1}function feelPassesRuleCriteria(e,l){return ruleUsesOldCriteria(l)?feelPassesOldRuleCriteria(e,l):feelPassesNewRuleCriteria(e,l)}function getFeelingToSchedule(e,l){var n;return l.field("Copy Feeling")?(n=e.field("Feeling (Reference)")).length>0?n[0].field("displayID"):(message("No Feeling To Schedule because feel doesn't have 'Feeling (Reference)'"),""):1==(n=l.field("Schedule Feeling (Reference)")).length?n[0].field("displayID"):n.length>1?n[Math.floor(Math.random()*n.length)].field("displayID"):(message("No Feeling To Schedule because rule doesn't have 'Schedule Feeling (Reference)'"),"")}function getTimeToSchedule(e){var l=e.field("After Time Magnitude"),n=e.field("After Time Unit (Reference)");n.length>0&&(n=n[0].field("Lowercase"));var i=moment();l>0&&(i=moment().add(l,n));var r=e.field("Schedule Timeline Type (Reference)");r.length>0&&(r=r[0].field("displayID"));var t=e.field("Time magnitude");"Within"==r&&(t=Math.floor(Math.random()*t));var a=e.field("Time Unit (Reference)");return a.length>0&&(a=a[0].field("Lowercase")),moment(i).add(t,a).valueOf()}function scheduleFeelingForRule(e,l){var n=getFeelingToSchedule(e,l),i=getTimeToSchedule(l),r=moment().valueOf(),t={"Feel (Reference)":e.field("displayID"),"Feeling (Reference)":n,"Scheduled Timestamp":i,"Rule entryID":l.field("entryID"),"Do Not Cleanup":l.field("Do Not Cleanup Schedule Entry"),Description:"rule being scheduled: "+l.field("displayID"),Timestamp:r,EntryBeganMoment:r,EntrySavedMoment:r,EntryLastUpdatedMoment:r,Test:l.field("Test")||e.field("Test")};libByName("Feeling Schedule").create(t).link("Feeling Schedule Rule (Reference)",l)}function doesRuleTriggerFollowUp(e){return e.field("Copy Feeling")||e.field("Copy Intensity Value")||e.field("Copy Feeling: Questionable")||e.field("Copy Comment")||e.field("Copy Locale Override")||e.field("Copy Positive/Negative Override")||e.field("Copy Details: Questionable")||e.field("Copy Body Parts")||e.field("Copy Person Relationship")}function rescheduleFeelingIfPossible(e){var l=e.field("Feeling Schedule Entry (Reference)");if(l.length>0){var n=(l=l[0]).field("Feeling Schedule Rule (Reference)");if(n.length>0&&doesRuleTriggerFollowUp(n=n[0])){var i=l.field("Feel (Reference)");if(i.length>0)return schedulEntryFeel=i[0],scheduleFeelingForRule(schedulEntryFeel,n)}}return null}function deleteFeelScheduleEntry(e){return!e.field("Do Not Cleanup")&&(e.trash(),!0)}function cleanupFeelingSchedule(){for(var e=libByName("Feeling Schedule").entries(),l=e.length,n=0;n<l;n++)for(var i=e[n],r=i.field("Scheduled Timestamp"),t=i.field("Feeling (Reference)")[0].field("displayID"),a=n+1;a<l;a++){var s=e[a],f=s.field("Scheduled Timestamp");t==s.field("Feeling (Reference)")[0].field("displayID")&&(r<=f?deleteFeelScheduleEntry(s)||message("failed to delete subsequentEntry "+s.field("displayIDSuffix")):deleteFeelScheduleEntry(i)||message("failed to delete currentEntry "+i.field("displayIDSuffix")))}return l-libByName("Feeling Schedule").entries().length}function addToFeelingBuffer(e){if(e.field("Test"))return"test";var l=moment().valueOf(),n={"Occurred At Timestamp":e.field("Timestamp"),Timestamp:l,EntryBeganMoment:l,EntrySavedMoment:l,EntryLastUpdatedMoment:l},i=libByName("Feeling Buffer").create(n);if(null!=i&&null!=i){var r=getFirstElementOrNull(e.field("Feeling (Reference)"));return null!=r&&i.link("Feeling (Reference)",r),i}return null}
