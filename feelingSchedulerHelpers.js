function passesOR(e){var l=!1;if(e.length>0)for(var i=0;i<e.length;i++)if(1==e[i]){l=!0;break}return l}function passesAND(e){var l=!0;if(e.length>0){for(var i=0;i<e.length;i++)if(0==e[i]){l=!1;break}}else l=!1;return l}function passesBoolCondition(e,l){if(0==e.length)return!1;if(1==e.length)return e[0];if(e.length>1){if(null==l)return passesAND(e);switch(l){case"And":return passesAND(e);case"Or":return passesOR(e);default:return message("somehow have "+e.length+" booleans, but the operator is "+l),!1}}}function passesNumCondition(e,l,i){switch(l){case"Equals":return e==i;case"Less Than":return e<i;case"Less Than or Equal To":return e<=i;case"Greater Than":return e>i;case"Greater Than or Equal To":return e>=i;default:return message("somehow have operator = "+l+". num1 = "+e+". num2 = "+i),!1}}function ruleUsesOldCriteria(e){return e.field("Operator (Reference)").length>0}function feelPassesOldRuleCriteria(e,l){var i=e.field("Intensity"),n=l.field("Operator (Reference)");return n.length>0&&(n=n[0].field("displayID")),passesNumCondition(i,n,l.field("Compare Value"))}function clauseUsesValueComparison(e){return e.field("Value Comparison Operator (Reference)").length>0}function feelPassesValueComparisonClause(e,l){var i=e.field("Intensity"),n=l.field("Value Comparison Operator (Reference)");return n.length>0&&passesNumCondition(i,n=n[0].field("displayID"),l.field("Compare Value"))}function feelPassesDataExistenceClause(e,l){var i=l.field("Data Existence Operator (Reference)");if(null!=(i=i.length>0?i[0].field("displayID"):null)||l.field("Comment")||l.field("Locale Override")||l.field("Positive / Negative Override")||l.field("Body Parts")||l.field("Person Relationship")||l.field("Questionable Feeling")||l.field("Questionable Details"))return!1;var n=[];return l.field("Comment")&&n.push(feelHasComment(e)),l.field("Locale Override")&&n.push(feelHasLocaleOverride(e)),l.field("Positive / Negative Override")&&n.push(feelHasPosNegOverride(e)),l.field("Body Parts")&&n.push(feelHasBodyParts(e)),l.field("Person Relationship")&&n.push(feelHasPersonRelationship(e)),l.field("Questionable Feeling")&&n.push(feelHasFeelingQuestionable(e)),l.field("Questionable Details")&&n.push(feelHasDetailsQuestionable(e)),passesBoolCondition(n,i)}function feelPassesClause(e,l){return clauseUsesValueComparison(l)?feelPassesValueComparisonClause(e,l):feelPassesDataExistenceClause(e,l)}function feelPassesNewRuleCriteria(e,l){var i=l.field("Selection Criteria Operator (Reference)");i=i.length>0?i[0].field("displayID"):null;var n=l.field("Selection Clause (Reference)");if(n.length>0){for(var r=[],t=0;t<n.length;t++)r.push(feelPassesClause(e,n[t]));return passesBoolCondition(r,i)}return!1}function feelPassesRuleCriteria(e,l){return ruleUsesOldCriteria(l)?feelPassesOldRuleCriteria(e,l):feelPassesNewRuleCriteria(e,l)}function getFeelingToSchedule(e,l){var i;return l.field("Copy Feeling")?(i=e.field("Feeling (Reference)")).length>0?i[0].field("displayID"):(message("No Feeling To Schedule because feel doesn't have 'Feeling (Reference)'"),""):1==(i=l.field("Schedule Feeling (Reference)")).length?i[0].field("displayID"):i.length>1?i[Math.floor(Math.random()*i.length)].field("displayID"):(message("No Feeling To Schedule because rule doesn't have 'Schedule Feeling (Reference)'"),"")}function getTimeToSchedule(e){var l=e.field("After Time Magnitude"),i=e.field("After Time Unit (Reference)");i.length>0&&(i=i[0].field("Lowercase"));var n=moment();l>0&&(n=moment().add(l,i));var r=e.field("Schedule Timeline Type (Reference)");r.length>0&&(r=r[0].field("displayID"));var t=e.field("Time magnitude");"Within"==r&&(t=Math.floor(Math.random()*t));var a=e.field("Time Unit (Reference)");return a.length>0&&(a=a[0].field("Lowercase")),moment(n).add(t,a).valueOf()}function scheduleFeelingForRule(e,l){var i=getFeelingToSchedule(e,l),n=getTimeToSchedule(l),r=moment().valueOf(),t={"Feel (Reference)":e.field("displayID"),"Feeling (Reference)":i,"Scheduled Timestamp":n,"Rule entryID":l.field("entryID"),"Do Not Cleanup":l.field("Do Not Cleanup Schedule Entry"),Description:"rule being scheduled: "+l.field("displayID"),Timestamp:r,EntryBeganMoment:r,EntrySavedMoment:r,EntryLastUpdatedMoment:r,Test:l.field("Test")||e.field("Test")};libByName("Feeling Schedule").create(t).link("Feeling Schedule Rule (Reference)",l)}function doesRuleTriggerFollowUp(e){return e.field("Copy Feeling")||e.field("Copy Intensity Value")||e.field("Copy Feeling: Questionable")||e.field("Copy Comment")||e.field("Copy Locale Override")||e.field("Copy Positive/Negative Override")||e.field("Copy Details: Questionable")||e.field("Copy Body Parts")||e.field("Copy Person Relationship")}function rescheduleFeelingIfPossible(e){var l=e.field("Feeling Schedule Entry (Reference)");if(l.length>0){var i=(l=l[0]).field("Feeling Schedule Rule (Reference)");if(i.length>0&&doesRuleTriggerFollowUp(i=i[0])){var n=l.field("Feel (Reference)");if(n.length>0)return schedulEntryFeel=n[0],scheduleFeelingForRule(schedulEntryFeel,i)}}return null}function deleteFeelScheduleEntry(e){return!e.field("Do Not Cleanup")&&(e.trash(),!0)}function cleanupFeelingSchedule(){for(var e=libByName("Feeling Schedule").entries(),l=e.length,i=0;i<l;i++)for(var n=e[i],r=n.field("Scheduled Timestamp"),t=n.field("Feeling (Reference)")[0].field("displayID"),a=i+1;a<l;a++){var s=e[a],f=s.field("Scheduled Timestamp");t==s.field("Feeling (Reference)")[0].field("displayID")&&(r<=f?deleteFeelScheduleEntry(s)||message("failed to delete subsequentEntry "+s.field("displayIDSuffix")):deleteFeelScheduleEntry(n)||message("failed to delete currentEntry "+n.field("displayIDSuffix")))}return l-libByName("Feeling Schedule").entries().length}function addToFeelingBuffer(e){if(e.field("Test"))return"test";var l=getDisplayID(getFirstElementOrNull(e.field("Feeling (Reference)"))),i=moment().valueOf(),n={"Occurred At Timestamp":e.field("Timestamp"),"Feeling (Reference)":l,Timestamp:i,EntryBeganMoment:i,EntrySavedMoment:i,EntryLastUpdatedMoment:i},r=libByName("Feeling Buffer").create(n);return null!=r&&null!=r?r:null}
